name: Autofix after pipeline

on:
  workflow_run:
    workflows:
      - "Python Security Scan (Bandit + Safety)"
      - "DAST - OWASP ZAP Scan"
      - "DAST - OWASP ZAP Active Scan"
      - "CodeQL Analysis (SAST)"
    types: [completed]

permissions:
  # Read workflow runs to gate properly
  actions: read
  # Read code scanning alerts
  security-events: read
  # Push branch + create PR
  contents: write
  pull-requests: write

concurrency:
  group: autofix-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: false

jobs:
  gate-and-autofix:
    # Only act on default branch completions
    if: ${{ github.event.workflow_run.head_branch == github.event.repository.default_branch }}
    runs-on: ubuntu-latest

    steps:
      - name: Gate on all workflows succeeding for this SHA
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          set -euo pipefail

          REQUIRED=(
            "Python Security Scan (Bandit + Safety)"
            "DAST - OWASP ZAP Scan"
            "DAST - OWASP ZAP Active Scan"
            "CodeQL Analysis (SAST)"
          )

          echo "Checking required workflow runs for SHA: $SHA"

          RUNS_JSON="$(gh api -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/$REPO/actions/runs?per_page=100&head_sha=$SHA")"

          missing=0
          failed=0

          for wf in "${REQUIRED[@]}"; do
            conc="$(echo "$RUNS_JSON" | jq -r --arg WF "$wf" '
              .workflow_runs
              | map(select(.name == $WF))
              | sort_by(.run_number)
              | last
              | .conclusion // empty
            ')"

            if [ -z "$conc" ]; then
              echo "❗ Missing run for: $wf"
              missing=1
            else
              echo "• $wf -> $conc"
              if [ "$conc" != "success" ]; then
                failed=1
              fi
            fi
          done

          # If not all present yet, no-op (this will run again when others complete)
          if [ "$missing" -eq 1 ]; then
            echo "Not all required workflows have completed yet. Exiting."
            exit 0
          fi

          # If any failed/cancelled/timed_out, do not autofix
          if [ "$failed" -eq 1 ]; then
            echo "At least one required workflow did not succeed. Not running autofix."
            exit 0
          fi

          echo "✅ All required workflows succeeded. Proceeding to autofix."

      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: Create/update proposed-fixes branch baseline
        run: |
          set -euo pipefail
          git fetch origin
          git checkout -B proposed-fixes origin/${{ github.event.repository.default_branch }}
          git config user.name "autofix-bot"
          git config user.email "autofix-bot@users.noreply.github.com"

      - name: Generate + commit Copilot Autofix for open code scanning alerts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # List open code scanning alerts (CodeQL lives here)
          alerts="$(gh api -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/$REPO/code-scanning/alerts?state=open&per_page=100")"

          nums="$(echo "$alerts" | jq -r '.[].number')"
          if [ -z "$nums" ]; then
            echo "No open code scanning alerts. Exiting."
            exit 0
          fi

          for n in $nums; do
            echo "=== Alert #$n ==="

            # Request autofix (no-op if unsupported)
            gh api -X POST -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/$REPO/code-scanning/alerts/$n/autofix" >/dev/null || true

            # Poll status (~5 mins max)
            status="unknown"
            for i in $(seq 1 30); do
              status="$(gh api -H "X-GitHub-Api-Version: 2022-11-28" \
                "/repos/$REPO/code-scanning/alerts/$n/autofix" --jq '.status' 2>/dev/null || echo "unavailable")"
              echo "status=$status"
              if [ "$status" = "complete" ] || [ "$status" = "failed" ] || [ "$status" = "unavailable" ]; then
                break
              fi
              sleep 10
            done

            # Commit autofix to proposed-fixes (no-op if no fix available)
            gh api -X POST -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/$REPO/code-scanning/alerts/$n/autofix/commits" \
              -f target_ref="proposed-fixes" >/dev/null || true
          done

      - name: Push proposed-fixes branch
        run: |
          set -euo pipefail
          git push -f origin proposed-fixes

      - name: Create or update PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BASE: ${{ github.event.repository.default_branch }}
        run: |
          set -euo pipefail

          pr_url="$(gh pr list --repo "$REPO" --head proposed-fixes --base "$BASE" --json url --jq '.[0].url' || true)"

          if [ -z "$pr_url" ]; then
            gh pr create --repo "$REPO" \
              --head proposed-fixes --base "$BASE" \
              --title "Proposed fixes (Copilot Autofix)" \
              --body "Automated PR containing Copilot Autofix commits for current CodeQL/code-scanning alerts."
          else
            gh pr edit "$pr_url" \
              --title "Proposed fixes (Copilot Autofix)" \
              --body "Updated automated PR with Copilot Autofix commits for current CodeQL/code-scanning alerts."
          fi

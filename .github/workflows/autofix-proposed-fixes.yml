name: Autofix after pipeline

on:
  workflow_run:
    workflows:
      - "Python Security Scan (Bandit + Safety)"
      - "DAST - OWASP ZAP Scan"
      - "DAST - OWASP ZAP Active Scan"
      - "CodeQL Analysis (SAST)"
    types: [completed]

permissions:
  # Read workflow runs to gate properly
  actions: read
  # Read code scanning alerts
  security-events: read
  # Push branch + create PR
  contents: write
  pull-requests: write

concurrency:
  group: autofix-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: false

jobs:
  gate-and-autofix:
    # Only act on default branch completions
    if: ${{ github.event.workflow_run.head_branch == github.event.repository.default_branch }}
    runs-on: ubuntu-latest

    steps:
      - name: Gate on all workflows succeeding for this SHA
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          set -euo pipefail

          REQUIRED=(
            "Python Security Scan (Bandit + Safety)"
            "DAST - OWASP ZAP Scan"
            "DAST - OWASP ZAP Active Scan"
            "CodeQL Analysis (SAST)"
          )

          echo "Checking required workflow runs for SHA: $SHA"

          RUNS_JSON="$(gh api -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/$REPO/actions/runs?per_page=100&head_sha=$SHA")"

          missing=0
          failed=0

          for wf in "${REQUIRED[@]}"; do
            conc="$(echo "$RUNS_JSON" | jq -r --arg WF "$wf" '
              .workflow_runs
              | map(select(.name == $WF))
              | sort_by(.run_number)
              | last
              | .conclusion // empty
            ')"

            if [ -z "$conc" ]; then
              echo "❗ Missing run for: $wf"
              missing=1
            else
              echo "• $wf -> $conc"
              if [ "$conc" != "success" ]; then
                failed=1
              fi
            fi
          done

          # If not all present yet, no-op (this will run again when others complete)
          if [ "$missing" -eq 1 ]; then
            echo "Not all required workflows have completed yet. Exiting."
            exit 0
          fi

          # If any failed/cancelled/timed_out, do not autofix
          if [ "$failed" -eq 1 ]; then
            echo "At least one required workflow did not succeed. Not running autofix."
            exit 0
          fi

          echo "✅ All required workflows succeeded. Proceeding to autofix."

      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: Create/update proposed-fixes branch baseline
        run: |
          set -euo pipefail
          git fetch origin
          git checkout -B proposed-fixes origin/${{ github.event.repository.default_branch }}
          git config user.name "autofix-bot"
          git config user.email "autofix-bot@users.noreply.github.com"

      - name: Generate + commit Copilot Autofix for open code scanning alerts
        continue-on-error: true
        timeout-minutes: 10
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # Create debug log directory
          mkdir -p autofix-debug-logs

          # List open code scanning alerts (CodeQL lives here)
          echo "=== API Call: GET /repos/$REPO/code-scanning/alerts ===" | tee -a autofix-debug-logs/api-calls.log
          alerts="$(timeout 30s curl -s -w "\nHTTP_CODE:%{http_code}\n" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/code-scanning/alerts?state=open&per_page=100" \
            2>&1 | tee autofix-debug-logs/01-list-alerts-response.txt || echo "[]")"

          # Extract just the JSON body (before HTTP_CODE line)
          alerts_json="$(echo "$alerts" | sed '/^HTTP_CODE:/Q')"
          http_code="$(echo "$alerts" | grep "^HTTP_CODE:" | cut -d: -f2)"
          echo "Response HTTP code: $http_code" | tee -a autofix-debug-logs/api-calls.log

          nums="$(echo "$alerts_json" | jq -r '.[].number' 2>/dev/null || echo "")"
          if [ -z "$nums" ]; then
            echo "⚠️  No open code scanning alerts found or API unavailable." | tee -a autofix-debug-logs/api-calls.log
            echo "Copilot Autofix requires GitHub Advanced Security and may not be available for this repository." | tee -a autofix-debug-logs/api-calls.log
            echo "Full response saved to autofix-debug-logs/01-list-alerts-response.txt"
            exit 0
          fi

          echo "Found $(echo "$nums" | wc -w) alert(s) to process" | tee -a autofix-debug-logs/api-calls.log

          for n in $nums; do
            echo "" | tee -a autofix-debug-logs/api-calls.log
            echo "=== Processing Alert #$n ===" | tee -a autofix-debug-logs/api-calls.log

            # Request autofix (no-op if unsupported)
            echo "API Call: POST /repos/$REPO/code-scanning/alerts/$n/autofix" | tee -a autofix-debug-logs/api-calls.log
            autofix_request_response="$(timeout 30s curl -v -X POST \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/code-scanning/alerts/$n/autofix" \
              2>&1 | tee autofix-debug-logs/02-alert-${n}-autofix-request.txt || echo "FAILED")"

            autofix_http_code="$(echo "$autofix_request_response" | grep "< HTTP" | tail -1 | awk '{print $3}')"
            echo "Autofix request HTTP code: $autofix_http_code" | tee -a autofix-debug-logs/api-calls.log

            if echo "$autofix_request_response" | grep -q "FAILED"; then
              echo "⚠️  Autofix request failed or timed out for alert #$n" | tee -a autofix-debug-logs/api-calls.log
              continue
            fi

            # Poll status (~2 mins max with timeouts)
            status="unknown"
            for i in $(seq 1 12); do
              echo "API Call: GET /repos/$REPO/code-scanning/alerts/$n/autofix (poll $i/12)" | tee -a autofix-debug-logs/api-calls.log
              status_response="$(timeout 10s curl -v \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$REPO/code-scanning/alerts/$n/autofix" \
                2>&1 | tee autofix-debug-logs/03-alert-${n}-status-poll-${i}.txt || echo "{\"status\":\"unavailable\"}")"

              status_http_code="$(echo "$status_response" | grep "< HTTP" | tail -1 | awk '{print $3}')"
              status_body="$(echo "$status_response" | grep -v "^[<>*]" | grep -v "^{" | tail -1)"
              status="$(echo "$status_response" | grep "^{" | jq -r '.status // "unavailable"' 2>/dev/null || echo "unavailable")"

              echo "  Poll $i/12: HTTP $status_http_code, status=$status" | tee -a autofix-debug-logs/api-calls.log

              if [ "$status" = "complete" ]; then
                echo "✅ Autofix complete for alert #$n" | tee -a autofix-debug-logs/api-calls.log
                break
              elif [ "$status" = "failed" ]; then
                echo "❌ Autofix failed for alert #$n" | tee -a autofix-debug-logs/api-calls.log
                break
              elif [ "$status" = "unavailable" ] || [ "$status" = "timeout" ]; then
                echo "⚠️  Autofix unavailable or timed out for alert #$n" | tee -a autofix-debug-logs/api-calls.log
                break
              fi

              sleep 10
            done

            # Commit autofix to proposed-fixes (no-op if no fix available)
            if [ "$status" = "complete" ]; then
              echo "API Call: POST /repos/$REPO/code-scanning/alerts/$n/autofix/commits" | tee -a autofix-debug-logs/api-calls.log
              commit_response="$(timeout 30s curl -v -X POST \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                -H "Accept: application/vnd.github+json" \
                -H "Content-Type: application/json" \
                -d "{\"target_ref\":\"proposed-fixes\"}" \
                "https://api.github.com/repos/$REPO/code-scanning/alerts/$n/autofix/commits" \
                2>&1 | tee autofix-debug-logs/04-alert-${n}-commit.txt || echo "FAILED")"

              commit_http_code="$(echo "$commit_response" | grep "< HTTP" | tail -1 | awk '{print $3}')"
              echo "Commit HTTP code: $commit_http_code" | tee -a autofix-debug-logs/api-calls.log

              if echo "$commit_response" | grep -q "FAILED"; then
                echo "⚠️  Failed to commit autofix for alert #$n" | tee -a autofix-debug-logs/api-calls.log
              fi
            fi
          done

          echo "" | tee -a autofix-debug-logs/api-calls.log
          echo "✅ Autofix processing complete" | tee -a autofix-debug-logs/api-calls.log
          echo "" | tee -a autofix-debug-logs/api-calls.log
          echo "Debug logs saved in autofix-debug-logs/ directory" | tee -a autofix-debug-logs/api-calls.log

      - name: Upload Autofix Debug Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: autofix-debug-logs
          path: autofix-debug-logs/
          if-no-files-found: warn

      - name: Push proposed-fixes branch
        run: |
          set -euo pipefail
          git push -f origin proposed-fixes

      - name: Create or update PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BASE: ${{ github.event.repository.default_branch }}
        run: |
          set -euo pipefail

          # Check if there are any differences between branches
          comparison="$(gh api "/repos/$REPO/compare/$BASE...proposed-fixes" --jq '.ahead_by')"

          if [ "$comparison" -eq 0 ]; then
            echo "⚠️  No commits on proposed-fixes branch (Copilot Autofix may be unavailable)"
            echo "Skipping PR creation - no changes to propose"
            exit 0
          fi

          echo "Found $comparison commit(s) to propose"

          pr_url="$(gh pr list --repo "$REPO" --head proposed-fixes --base "$BASE" --json url --jq '.[0].url' || true)"

          if [ -z "$pr_url" ]; then
            echo "Creating new PR..."
            gh pr create --repo "$REPO" \
              --head proposed-fixes --base "$BASE" \
              --title "Proposed fixes (Copilot Autofix)" \
              --body "Automated PR containing Copilot Autofix commits for current CodeQL/code-scanning alerts."
          else
            echo "Updating existing PR: $pr_url"
            gh pr edit "$pr_url" \
              --title "Proposed fixes (Copilot Autofix)" \
              --body "Updated automated PR with Copilot Autofix commits for current CodeQL/code-scanning alerts."
          fi
